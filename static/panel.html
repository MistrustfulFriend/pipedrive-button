<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DataFielder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@0/dist/index.umd.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
    <style>
      :root {
        /* Pipedrive design tokens */
        --pd-green:        #1db954;
        --pd-green-dark:   #19a349;
        --pd-green-alpha:  rgba(29,185,84,0.10);
        --pd-navy:         #1a1f36;
        --pd-text:         #1a1f36;
        --pd-text-secondary: #6b7280;
        --pd-text-muted:   #9ca3af;
        --pd-border:       #e5e7eb;
        --pd-border-strong:#d1d5db;
        --pd-bg:           #ffffff;
        --pd-bg-subtle:    #f9fafb;
        --pd-bg-hover:     #f3f4f6;
        --pd-blue:         #2563eb;
        --pd-blue-light:   #eff6ff;
        --pd-blue-border:  #bfdbfe;
        --pd-red:          #dc2626;
        --pd-red-light:    #fef2f2;
        --pd-red-border:   #fca5a5;
        --pd-yellow:       #d97706;
        --pd-yellow-light: #fffbeb;
        --pd-yellow-border:#fcd34d;
        --radius-sm:       4px;
        --radius:          6px;
        --radius-lg:       10px;
        --shadow-sm:       0 1px 2px rgba(0,0,0,0.05);
        --shadow:          0 1px 3px rgba(0,0,0,0.10), 0 1px 2px rgba(0,0,0,0.06);
        --font:            'Inter', -apple-system, "Segoe UI", Helvetica, Arial, sans-serif;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: var(--font);
        font-size: 13px;
        color: var(--pd-text);
        background: var(--pd-bg);
        padding: 14px;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* ── Header ─────────────────────────────────────────────── */
      .header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 14px;
        padding-bottom: 14px;
        border-bottom: 1px solid var(--pd-border);
      }

      .logo {
        width: 32px; height: 32px;
        flex-shrink: 0;
        border-radius: var(--radius);
        background: var(--pd-navy);
        display: flex; align-items: center; justify-content: center;
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .logo svg { width: 20px; height: 20px; }

      .header-text { flex: 1; min-width: 0; }
      .header-text h1 {
        font-size: 13px;
        font-weight: 600;
        color: var(--pd-text);
        letter-spacing: -0.01em;
        line-height: 1.3;
      }
      .header-text p {
        font-size: 11px;
        color: var(--pd-text-muted);
        margin-top: 1px;
        line-height: 1.3;
      }

      /* Status dot */
      .status-dot {
        width: 6px; height: 6px;
        border-radius: 50%;
        background: var(--pd-green);
        box-shadow: 0 0 0 2px var(--pd-green-alpha);
        flex-shrink: 0;
        margin-top: 1px;
      }

      /* ── Main button ─────────────────────────────────────────── */
      .btn {
        display: flex; align-items: center; justify-content: center; gap: 7px;
        width: 100%; padding: 9px 16px;
        border: none; border-radius: var(--radius);
        font-family: var(--font); font-size: 13px; font-weight: 500;
        cursor: pointer; line-height: 1;
        transition: background 0.15s, box-shadow 0.15s, transform 0.1s, opacity 0.15s;
        -webkit-font-smoothing: antialiased;
        letter-spacing: -0.01em;
      }

      .btn-primary {
        background: var(--pd-green);
        color: #fff;
        box-shadow: 0 1px 2px rgba(29,185,84,0.25), 0 0 0 1px rgba(29,185,84,0.20) inset;
      }
      .btn-primary:hover:not(:disabled) {
        background: var(--pd-green-dark);
        box-shadow: 0 2px 6px rgba(29,185,84,0.30), 0 0 0 1px rgba(29,185,84,0.20) inset;
      }
      .btn-primary:active:not(:disabled) { transform: scale(0.985); }
      .btn:disabled { opacity: 0.50; cursor: not-allowed; }

      .btn-icon {
        width: 15px; height: 15px; flex-shrink: 0;
        stroke: currentColor; fill: none;
        stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
      }

      .spinner {
        width: 14px; height: 14px; flex-shrink: 0;
        border: 2px solid rgba(255,255,255,0.30);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.65s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

      .btn-hint {
        font-size: 11px;
        color: var(--pd-text-muted);
        margin-top: 7px;
        text-align: center;
        letter-spacing: 0;
      }

      /* ── Result card ─────────────────────────────────────────── */
      .result-card {
        margin-top: 12px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--pd-border);
        overflow: hidden;
        display: none;
        animation: slideIn 0.2s ease;
      }
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(4px); }
        to   { opacity: 1; transform: translateY(0); }
      }
      .result-card.visible { display: block; }

      /* Card header bar */
      .card-bar {
        display: flex; align-items: center; gap: 8px;
        padding: 10px 12px;
        font-size: 12px; font-weight: 600;
      }
      .card-bar-icon {
        width: 16px; height: 16px; flex-shrink: 0;
        stroke: currentColor; fill: none;
        stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
      }
      .card-bar-text { flex: 1; line-height: 1.3; }
      .card-bar-count {
        font-size: 11px; font-weight: 600;
        padding: 1px 7px; border-radius: 20px;
        letter-spacing: 0;
      }

      /* States */
      .state-success .card-bar { background: #f0fdf4; color: #166534; border-bottom: 1px solid #bbf7d0; }
      .state-success .card-bar-count { background: #dcfce7; color: #166534; }
      .state-success .card-body  { background: #fff; }

      .state-warning .card-bar { background: #fffbeb; color: #92400e; border-bottom: 1px solid #fde68a; }
      .state-warning .card-bar-count { background: #fef3c7; color: #92400e; }
      .state-warning .card-body  { background: #fff; }

      .state-error .card-bar { background: #fef2f2; color: #991b1b; border-bottom: 1px solid #fecaca; }
      .state-error .card-bar-count { background: #fee2e2; color: #991b1b; }
      .state-error .card-body  { background: #fff; }

      .card-body { padding: 10px 12px; }

      /* Field groups */
      .field-group { margin-bottom: 9px; }
      .field-group:last-child { margin-bottom: 0; }

      .group-label {
        font-size: 10px; font-weight: 600;
        text-transform: uppercase; letter-spacing: 0.06em;
        color: var(--pd-text-muted);
        margin-bottom: 5px;
        display: flex; align-items: center; gap: 5px;
      }
      .group-label-dot {
        width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0;
      }

      .chip-row { display: flex; flex-wrap: wrap; gap: 4px; }

      .chip {
        display: inline-flex; align-items: center; gap: 4px;
        padding: 3px 8px 3px 6px;
        border-radius: 20px;
        font-size: 11px; font-weight: 500;
        line-height: 1;
        border: 1px solid transparent;
      }
      .chip svg {
        width: 10px; height: 10px; flex-shrink: 0;
        stroke: currentColor; fill: none;
        stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round;
      }

      .chip-green {
        background: #f0fdf4; border-color: #bbf7d0; color: #166534;
      }
      .chip-blue {
        background: #eff6ff; border-color: var(--pd-blue-border); color: #1e40af;
      }
      .chip-grey {
        background: var(--pd-bg-subtle); border-color: var(--pd-border); color: var(--pd-text-secondary);
      }

      .divider {
        height: 1px;
        background: var(--pd-border);
        margin: 9px 0;
      }


      /* ── Date range (deal only) ──────────────────────────────── */
      .date-range {
        display: none;
        margin-top: 12px;
        padding: 11px 12px;
        background: var(--pd-bg-subtle);
        border: 1px solid var(--pd-border);
        border-radius: var(--radius-lg);
        animation: slideIn 0.18s ease;
      }
      .date-range.visible { display: block; }

      .date-range-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--pd-text-secondary);
        letter-spacing: 0.02em;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .date-range-title svg {
        width: 12px; height: 12px; flex-shrink: 0;
        stroke: var(--pd-text-muted); fill: none;
        stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
        opacity: 0.7;
      }

      .date-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .date-field label {
        display: block;
        font-size: 10px;
        font-weight: 500;
        color: var(--pd-text-muted);
        margin-bottom: 3px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .date-field input[type="date"] {
        width: 100%;
        padding: 6px 8px;
        font-family: var(--font);
        font-size: 12px;
        color: var(--pd-text);
        background: var(--pd-bg);
        border: 1px solid var(--pd-border-strong);
        border-radius: var(--radius);
        outline: none;
        transition: border-color 0.15s, box-shadow 0.15s;
        -webkit-appearance: none;
      }
      .date-field input[type="date"]:focus {
        border-color: var(--pd-green);
        box-shadow: 0 0 0 2px var(--pd-green-alpha);
      }

      .date-hint {
        font-size: 10px;
        color: var(--pd-text-muted);
        margin-top: 7px;
        line-height: 1.4;
      }
      .date-clear {
        background: none;
        border: none;
        font-family: var(--font);
        font-size: 10px;
        color: var(--pd-text-muted);
        cursor: pointer;
        padding: 0;
        text-decoration: underline;
        text-underline-offset: 2px;
      }
      .date-clear:hover { color: var(--pd-text-secondary); }
      /* ── Notice (person / info) ──────────────────────────────── */
      .notice {
        display: flex; align-items: flex-start; gap: 9px;
        margin-top: 12px;
        padding: 10px 12px;
        background: var(--pd-bg-subtle);
        border: 1px solid var(--pd-border);
        border-radius: var(--radius-lg);
        font-size: 12px;
        color: var(--pd-text-secondary);
        line-height: 1.5;
      }
      .notice-icon {
        width: 14px; height: 14px; flex-shrink: 0; margin-top: 1px;
        stroke: var(--pd-text-muted); fill: none;
        stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
        opacity: 0.7;
      }
    </style>
  </head>

  <body>
    <div class="header">
      <div class="logo">
        <!-- Inline icon: lightning bolt over data rows -->
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <!-- rows -->
          <rect x="3" y="13" width="11" height="2.2" rx="1.1" fill="rgba(255,255,255,0.55)"/>
          <rect x="3" y="16.5" width="8"  height="2.2" rx="1.1" fill="rgba(255,255,255,0.35)"/>
          <!-- bolt -->
          <path d="M13 2 L9 11 H12.5 L9.5 22 L18 10 H14 L17 2 Z"
                fill="#1db954"/>
        </svg>
      </div>
      <div class="header-text">
        <h1>DataFielder</h1>
        <p>AI-powered field enrichment</p>
      </div>
      <div class="status-dot" title="Connected"></div>
    </div>

    <button class="btn btn-primary" id="btn-populate">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="16"/>
        <line x1="8" y1="12" x2="16" y2="12"/>
      </svg>
      Populate missing fields
    </button>
    <p class="btn-hint">Only empty fields will be updated</p>


    <div class="date-range" id="date-range">
      <div class="date-range-title">
        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Filter history by date range
      </div>
      <div class="date-row">
        <div class="date-field">
          <label for="date-from">From</label>
          <input type="date" id="date-from" />
        </div>
        <div class="date-field">
          <label for="date-to">To</label>
          <input type="date" id="date-to" />
        </div>
      </div>
      <div class="date-hint">
        Only notes &amp; activities within this range will be included in the summary.
        <button class="date-clear" id="date-clear">Clear dates</button>
      </div>
    </div>
    <div class="result-card" id="result-card">
      <div class="card-bar" id="card-bar">
        <svg class="card-bar-icon" id="card-bar-icon" viewBox="0 0 24 24"></svg>
        <span class="card-bar-text" id="card-bar-text"></span>
        <span class="card-bar-count" id="card-bar-count"></span>
      </div>
      <div class="card-body" id="card-body"></div>
    </div>

    <script>
    (async () => {
      const sdk = await new AppExtensionsSDK().initialize();
      try { await sdk.execute("resize", { height: 190 }); } catch(e) {}

      const btn        = document.getElementById("btn-populate");
      const card       = document.getElementById("result-card");
      const cardBar    = document.getElementById("card-bar");
      const barIcon    = document.getElementById("card-bar-icon");
      const barText    = document.getElementById("card-bar-text");
      const barCount   = document.getElementById("card-bar-count");
      const cardBody   = document.getElementById("card-body");

      const ICON_PATHS = {
        success: `<polyline points="20 6 9 17 4 12"/>`,
        warning: `<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/>`,
        error:   `<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>`,
      };

      const CHECK_SVG = `<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>`;
      const GLOBE_SVG = `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20"/></svg>`;
      const DASH_SVG  = `<svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg>`;

      function showResult(state, title, countLabel, groups) {
        card.className = `result-card visible state-${state}`;
        barIcon.innerHTML = ICON_PATHS[state] || ICON_PATHS.warning;
        barText.textContent = title;
        barCount.textContent = countLabel;
        barCount.style.display = countLabel ? "" : "none";
        cardBody.innerHTML = "";

        let groupsRendered = 0;
        groups.forEach(({ label, dotColor, fields, chipCls, iconSvg }) => {
          if (!fields || fields.length === 0) return;
          if (groupsRendered > 0) {
            const div = document.createElement("div");
            div.className = "divider";
            cardBody.appendChild(div);
          }
          const grp = document.createElement("div");
          grp.className = "field-group";
          const dot = dotColor ? `<span class="group-label-dot" style="background:${dotColor}"></span>` : "";
          const chips = fields.map(f => `<span class="chip ${chipCls}">${iconSvg}${f}</span>`).join("");
          grp.innerHTML = `
            <div class="group-label">${dot}${label}</div>
            <div class="chip-row">${chips}</div>
          `;
          cardBody.appendChild(grp);
          groupsRendered++;
        });

        if (groupsRendered === 0) {
          cardBody.style.display = "none";
        } else {
          cardBody.style.display = "";
        }

        const est = 190 + 28 + groupsRendered * 58;
        try { sdk.execute("resize", { height: Math.min(est, 400) }); } catch(e) {}
      }

      function setLoading(loading) {
        btn.disabled = loading;
        btn.innerHTML = loading
          ? `<div class="spinner"></div> Searching…`
          : `<svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg> Populate missing fields`;
      }

      const params   = Object.fromEntries(new URLSearchParams(location.search));
      const resource = params.resource;
      const id       = params.selectedIds || params.id;

      // Show date range picker only for deals
      const dateRange = document.getElementById("date-range");
      const dateFrom  = document.getElementById("date-from");
      const dateTo    = document.getElementById("date-to");
      const dateClear = document.getElementById("date-clear");

      if (resource === "deal") {
        dateRange.classList.add("visible");
        try { sdk.execute("resize", { height: 290 }); } catch(e) {}
      }

      dateClear.addEventListener("click", () => {
        dateFrom.value = "";
        dateTo.value   = "";
      });

      if (resource === "person") {
        const notice = document.createElement("div");
        notice.className = "notice";
        notice.innerHTML = `
          <svg class="notice-icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
          <span>Person enrichment isn't available. Open an <strong>Organisation</strong> or <strong>Deal</strong> record to use DataFielder.</span>
        `;
        document.body.appendChild(notice);
        btn.disabled = true;
        try { sdk.execute("resize", { height: 248 }); } catch(e) {}
      }

      btn.addEventListener("click", async () => {
        if (!resource || !id) {
          showResult("error", "Missing context", "", [
            { label: "Details", fields: ["Open this panel from a record page"], chipCls: "chip-grey", iconSvg: DASH_SVG },
          ]);
          return;
        }

        setLoading(true);
        // hide old card during load
        card.classList.remove("visible");

        try {
          const res  = await fetch("/api/populate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              resource,
              id,
              companyId: params.companyId,
              userId:    params.userId,
              date_from: dateFrom ? dateFrom.value : "",
              date_to:   dateTo   ? dateTo.value   : "",
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            showResult("error", "Could not populate fields", "", [
              { label: "Error", fields: [data.error || "Something went wrong"], chipCls: "chip-grey", iconSvg: DASH_SVG },
            ]);
            return;
          }

          const msg = data.message || "";

          if (msg.includes("already filled") || msg.includes("Nothing to do")) {
            showResult("warning", "Already up to date", "No changes", [
              { label: "Status", fields: ["All fields already have values"], chipCls: "chip-grey", iconSvg: DASH_SVG },
            ]);
            return;
          }

          const fromWebsite = data.filled_website || [];
          const fromWeb     = data.filled_web     || [];
          const notFound    = data.not_found       || [];
          const total       = fromWebsite.length + fromWeb.length;

          showResult("success", `Fields populated`, `${total} updated`, [
            {
              label:    "From website",
              dotColor: "#1db954",
              fields:   fromWebsite,
              chipCls:  "chip-green",
              iconSvg:  CHECK_SVG,
            },
            {
              label:    "From web search",
              dotColor: "#2563eb",
              fields:   fromWeb,
              chipCls:  "chip-blue",
              iconSvg:  GLOBE_SVG,
            },
            {
              label:    "Not found",
              dotColor: "#9ca3af",
              fields:   notFound,
              chipCls:  "chip-grey",
              iconSvg:  DASH_SVG,
            },
          ]);

        } catch(err) {
          showResult("error", "Network error", "", [
            { label: "Details", fields: [String(err)], chipCls: "chip-grey", iconSvg: DASH_SVG },
          ]);
        } finally {
          setLoading(false);
        }
      });
    })();
    </script>
  </body>
</html>